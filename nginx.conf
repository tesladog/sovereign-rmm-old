"""Settings — all server config editable from the dashboard."""
from fastapi import APIRouter, Depends
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from models import Setting
from main import get_db

router = APIRouter()

@router.get("/")
async def get_all_settings(db: AsyncSession = Depends(get_db)):
    result = await db.execute(select(Setting).order_by(Setting.category, Setting.key))
    settings = result.scalars().all()
    # Group by category
    grouped = {}
    for s in settings:
        cat = s.category or "general"
        if cat not in grouped:
            grouped[cat] = []
        # Mask passwords
        value = "••••••••" if any(x in s.key for x in ["pass", "token", "secret"]) else s.value
        grouped[cat].append({"key": s.key, "value": value, "label": s.label})
    return grouped

@router.get("/raw")
async def get_raw_settings(db: AsyncSession = Depends(get_db)):
    """Returns actual values — used internally by backend."""
    result = await db.execute(select(Setting))
    return {s.key: s.value for s in result.scalars().all()}

@router.put("/")
async def update_settings(data: dict, db: AsyncSession = Depends(get_db)):
    """Update one or many settings at once."""
    for key, value in data.items():
        if value == "••••••••":
            continue  # Skip masked — don't overwrite with placeholder
        result = await db.execute(select(Setting).where(Setting.key == key))
        s = result.scalar_one_or_none()
        if s:
            s.value = str(value)
        else:
            db.add(Setting(key=key, value=str(value)))
    await db.commit()
    return {"status": "saved"}

@router.get("/{key}")
async def get_setting(key: str, db: AsyncSession = Depends(get_db)):
    result = await db.execute(select(Setting).where(Setting.key == key))
    s = result.scalar_one_or_none()
    if not s:
        return {"key": key, "value": None}
    return {"key": s.key, "value": s.value, "label": s.label}
