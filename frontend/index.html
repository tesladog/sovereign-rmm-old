<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phantom RMM</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Syne:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:        #0a0b0e;
    --bg2:       #0f1115;
    --bg3:       #161921;
    --bg4:       #1e2230;
    --border:    #252b3a;
    --text:      #e2e8f0;
    --text2:     #8892a4;
    --text3:     #4a5568;
    --accent:    #4f8ef7;
    --accent2:   #3a6fd8;
    --green:     #22d3a3;
    --yellow:    #f5c842;
    --red:       #f05a5a;
    --orange:    #f07a3a;
    --purple:    #9b72f5;
    --mono:      'JetBrains Mono', monospace;
    --sans:      'Syne', sans-serif;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    height: 100vh;
    overflow: hidden;
    display: flex;
  }

  /* â”€â”€ Sidebar â”€â”€ */
  .sidebar {
    width: 220px;
    min-width: 220px;
    background: var(--bg2);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 0;
    z-index: 10;
  }

  .logo {
    padding: 22px 20px 18px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo-icon {
    width: 32px; height: 32px;
    background: var(--accent);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
  }

  .logo-text {
    font-size: 17px;
    font-weight: 800;
    letter-spacing: -0.3px;
    color: var(--text);
  }

  .logo-text span { color: var(--accent); }

  nav { flex: 1; padding: 12px 0; }

  .nav-section {
    padding: 6px 14px 2px;
    font-size: 9px;
    font-family: var(--mono);
    letter-spacing: 1.5px;
    color: var(--text3);
    text-transform: uppercase;
    margin-top: 8px;
  }

  .nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 18px;
    cursor: pointer;
    font-size: 13.5px;
    font-weight: 500;
    color: var(--text2);
    transition: all 0.15s;
    border-left: 3px solid transparent;
    position: relative;
  }

  .nav-item:hover { color: var(--text); background: var(--bg3); }

  .nav-item.active {
    color: var(--accent);
    background: rgba(79,142,247,0.08);
    border-left-color: var(--accent);
  }

  .nav-item .icon { font-size: 15px; width: 20px; text-align: center; }

  .nav-badge {
    margin-left: auto;
    background: var(--red);
    color: #fff;
    font-size: 10px;
    font-family: var(--mono);
    font-weight: 600;
    padding: 1px 6px;
    border-radius: 10px;
    min-width: 20px;
    text-align: center;
  }

  .sidebar-footer {
    padding: 14px 18px;
    border-top: 1px solid var(--border);
    font-size: 11px;
    font-family: var(--mono);
    color: var(--text3);
  }

  .connection-dot {
    display: inline-block;
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--green);
    margin-right: 6px;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* â”€â”€ Main area â”€â”€ */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .topbar {
    height: 58px;
    min-height: 58px;
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 24px;
    gap: 16px;
  }

  .topbar-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
  }

  .topbar-sub {
    font-size: 12px;
    font-family: var(--mono);
    color: var(--text3);
  }

  .topbar-actions { margin-left: auto; display: flex; gap: 10px; }

  .btn {
    padding: 7px 16px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-family: var(--sans);
    font-size: 13px;
    font-weight: 600;
    transition: all 0.15s;
  }

  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: var(--accent2); }
  .btn-ghost { background: transparent; color: var(--text2); border: 1px solid var(--border); }
  .btn-ghost:hover { background: var(--bg3); color: var(--text); }
  .btn-danger { background: rgba(240,90,90,0.15); color: var(--red); border: 1px solid rgba(240,90,90,0.3); }
  .btn-danger:hover { background: rgba(240,90,90,0.25); }
  .btn-sm { padding: 4px 10px; font-size: 12px; }

  /* â”€â”€ Pages â”€â”€ */
  .page { display: none; flex-direction: column; flex: 1; overflow: hidden; }
  .page.active { display: flex; }

  .page-body {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    scrollbar-width: thin;
    scrollbar-color: var(--bg4) transparent;
  }

  /* â”€â”€ Summary cards â”€â”€ */
  .cards-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }

  .card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 18px 20px;
    transition: border-color 0.2s;
  }

  .card:hover { border-color: var(--bg4); }

  .card-label {
    font-size: 11px;
    font-family: var(--mono);
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
  }

  .card-value {
    font-size: 32px;
    font-weight: 800;
    line-height: 1;
    margin-bottom: 6px;
  }

  .card-sub {
    font-size: 12px;
    font-family: var(--mono);
    color: var(--text3);
  }

  .card-value.green { color: var(--green); }
  .card-value.red   { color: var(--red); }
  .card-value.yellow { color: var(--yellow); }
  .card-value.accent { color: var(--accent); }

  /* â”€â”€ Device table â”€â”€ */
  .section-header {
    display: flex;
    align-items: center;
    margin-bottom: 14px;
    gap: 12px;
  }

  .section-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--text);
  }

  .section-count {
    font-size: 11px;
    font-family: var(--mono);
    color: var(--text3);
    background: var(--bg3);
    padding: 2px 8px;
    border-radius: 10px;
  }

  .search-bar {
    margin-left: auto;
    display: flex;
    gap: 8px;
  }

  .search-input {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 12px;
    font-family: var(--mono);
    font-size: 12px;
    color: var(--text);
    width: 200px;
    outline: none;
  }

  .search-input:focus { border-color: var(--accent); }
  .search-input::placeholder { color: var(--text3); }

  .table-wrap {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
  }

  table { width: 100%; border-collapse: collapse; }

  thead { background: var(--bg3); }

  th {
    padding: 10px 16px;
    text-align: left;
    font-size: 11px;
    font-family: var(--mono);
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    border-bottom: 1px solid var(--border);
    font-weight: 400;
  }

  tbody tr {
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.1s;
  }

  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: var(--bg3); }

  td {
    padding: 12px 16px;
    font-size: 13px;
    vertical-align: middle;
  }

  .status-dot {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    font-size: 12px;
    font-family: var(--mono);
  }

  .status-dot::before {
    content: '';
    display: inline-block;
    width: 8px; height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .status-dot.online::before  { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .status-dot.offline::before { background: var(--text3); }
  .status-dot.warning::before { background: var(--yellow); box-shadow: 0 0 6px var(--yellow); }

  .os-badge {
    font-size: 11px;
    font-family: var(--mono);
    padding: 3px 8px;
    border-radius: 4px;
    display: inline-block;
  }

  .os-windows { background: rgba(79,142,247,0.15); color: var(--accent); }
  .os-linux   { background: rgba(34,211,163,0.15); color: var(--green); }
  .os-android { background: rgba(155,114,245,0.15); color: var(--purple); }
  .os-macos   { background: rgba(245,200,66,0.15); color: var(--yellow); }

  /* â”€â”€ Gauge bars â”€â”€ */
  .mini-gauge {
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 100px;
  }

  .gauge-bar {
    flex: 1;
    height: 4px;
    background: var(--bg4);
    border-radius: 2px;
    overflow: hidden;
  }

  .gauge-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.5s ease;
  }

  .gauge-fill.green  { background: var(--green); }
  .gauge-fill.yellow { background: var(--yellow); }
  .gauge-fill.red    { background: var(--red); }

  .gauge-val {
    font-size: 11px;
    font-family: var(--mono);
    color: var(--text2);
    min-width: 34px;
    text-align: right;
  }

  /* â”€â”€ Battery indicator â”€â”€ */
  .battery {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-family: var(--mono);
    font-size: 12px;
  }

  .battery-icon {
    position: relative;
    width: 22px; height: 12px;
    border: 1.5px solid currentColor;
    border-radius: 2px;
  }

  .battery-icon::after {
    content: '';
    position: absolute;
    right: -5px; top: 50%;
    transform: translateY(-50%);
    width: 3px; height: 6px;
    background: currentColor;
    border-radius: 0 2px 2px 0;
  }

  .battery-fill {
    position: absolute;
    left: 1px; top: 1px; bottom: 1px;
    border-radius: 1px;
    transition: width 0.5s;
  }

  /* â”€â”€ Modal â”€â”€ */
  .modal-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 100;
    backdrop-filter: blur(4px);
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 12px;
    width: 640px;
    max-width: 95vw;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    animation: modal-in 0.2s ease;
  }

  @keyframes modal-in {
    from { opacity: 0; transform: scale(0.96) translateY(8px); }
    to   { opacity: 1; transform: scale(1) translateY(0); }
  }

  .modal-header {
    padding: 20px 24px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .modal-title { font-size: 16px; font-weight: 700; }

  .modal-close {
    background: none;
    border: none;
    color: var(--text3);
    cursor: pointer;
    font-size: 20px;
    padding: 4px;
    line-height: 1;
    transition: color 0.15s;
  }

  .modal-close:hover { color: var(--text); }

  .modal-body { padding: 20px 24px; overflow-y: auto; flex: 1; }

  .modal-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }

  /* â”€â”€ Form elements â”€â”€ */
  .form-row { margin-bottom: 16px; }

  .form-label {
    display: block;
    font-size: 11px;
    font-family: var(--mono);
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 6px;
  }

  .form-input, .form-select, .form-textarea {
    width: 100%;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 9px 12px;
    font-family: var(--mono);
    font-size: 13px;
    color: var(--text);
    outline: none;
    transition: border-color 0.15s;
  }

  .form-input:focus, .form-select:focus, .form-textarea:focus {
    border-color: var(--accent);
  }

  .form-textarea {
    resize: vertical;
    min-height: 140px;
    font-size: 12px;
    line-height: 1.6;
  }

  /* â”€â”€ Code / terminal â”€â”€ */
  .terminal {
    background: #0d0f14;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    font-family: var(--mono);
    font-size: 12px;
    color: var(--green);
    max-height: 280px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-all;
  }

  .terminal .line { line-height: 1.7; }
  .terminal .err  { color: var(--red); }
  .terminal .info { color: var(--text3); }

  /* â”€â”€ Policy sliders â”€â”€ */
  .policy-row {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 14px;
    padding: 12px 16px;
    background: var(--bg3);
    border-radius: 8px;
  }

  .policy-label { min-width: 160px; font-size: 13px; color: var(--text2); }

  .policy-slider {
    flex: 1;
    -webkit-appearance: none;
    height: 4px;
    border-radius: 2px;
    background: var(--bg4);
    outline: none;
    cursor: pointer;
  }

  .policy-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px; height: 14px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    box-shadow: 0 0 0 3px rgba(79,142,247,0.2);
  }

  .policy-val {
    min-width: 60px;
    text-align: right;
    font-family: var(--mono);
    font-size: 12px;
    color: var(--accent);
  }

  /* â”€â”€ Tabs â”€â”€ */
  .tabs {
    display: flex;
    gap: 4px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 20px;
  }

  .tab {
    padding: 10px 18px;
    font-size: 13px;
    font-weight: 600;
    color: var(--text3);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.15s;
  }

  .tab:hover { color: var(--text2); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  /* â”€â”€ Script editor â”€â”€ */
  .script-grid {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: 16px;
    height: calc(100vh - 160px);
  }

  .script-list {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow-y: auto;
  }

  .script-item {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.1s;
  }

  .script-item:hover { background: var(--bg3); }
  .script-item.active { background: rgba(79,142,247,0.1); border-left: 3px solid var(--accent); }

  .script-name { font-size: 13px; font-weight: 600; }
  .script-lang {
    font-size: 10px;
    font-family: var(--mono);
    color: var(--text3);
    margin-top: 2px;
  }

  .script-editor-panel {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .editor-toolbar {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--bg3);
  }

  /* â”€â”€ Toast notifications â”€â”€ */
  .toast-container {
    position: fixed;
    bottom: 24px; right: 24px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    z-index: 200;
  }

  .toast {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 10px;
    animation: toast-in 0.25s ease;
    max-width: 320px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  }

  .toast.success { border-left: 3px solid var(--green); }
  .toast.error   { border-left: 3px solid var(--red); }
  .toast.info    { border-left: 3px solid var(--accent); }

  @keyframes toast-in {
    from { opacity: 0; transform: translateX(20px); }
    to   { opacity: 1; transform: translateX(0); }
  }

  /* â”€â”€ Scrollbar â”€â”€ */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--bg4); border-radius: 3px; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<aside class="sidebar">
  <div class="logo">
    <div class="logo-icon">ðŸ‘»</div>
    <span class="logo-text">PHANT<span>OM</span></span>
  </div>
  <nav>
    <div class="nav-section">Monitor</div>
    <div class="nav-item active" onclick="showPage('dashboard')">
      <span class="icon">â¬¡</span> Dashboard
    </div>
    <div class="nav-item" onclick="showPage('devices')">
      <span class="icon">â—ˆ</span> Devices
      <span class="nav-badge" id="offlineBadge" style="display:none">0</span>
    </div>

    <div class="nav-section">Manage</div>
    <div class="nav-item" onclick="showPage('tasks')">
      <span class="icon">â—Ž</span> Tasks
      <span class="nav-badge" id="pendingBadge" style="display:none">0</span>
    </div>
    <div class="nav-item" onclick="showPage('scripts')">
      <span class="icon">âŒ¥</span> Scripts
    </div>
    <div class="nav-item" onclick="showPage('files')">
      <span class="icon">â—»</span> Files
    </div>

    <div class="nav-section">Config</div>
    <div class="nav-item" onclick="showPage('policies')">
      <span class="icon">â—±</span> Check-in Policies
    </div>
    <div class="nav-item" onclick="showPage('netbird')">
      <span class="icon">â¬¡</span> Netbird VPN
    </div>
  </nav>
  <div class="sidebar-footer">
    <span class="connection-dot"></span>
    <span id="wsStatus">Live feed connected</span>
  </div>
</aside>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main">

  <!-- â”€â”€ DASHBOARD page â”€â”€ -->
  <div class="page active" id="page-dashboard">
    <div class="topbar">
      <div>
        <div class="topbar-title">Dashboard</div>
        <div class="topbar-sub">System overview</div>
      </div>
      <div class="topbar-actions">
        <button class="btn btn-ghost btn-sm" onclick="refreshAll()">â†» Refresh</button>
      </div>
    </div>
    <div class="page-body">
      <div class="cards-row">
        <div class="card">
          <div class="card-label">Total Devices</div>
          <div class="card-value accent" id="totalDevices">â€”</div>
          <div class="card-sub" id="byOsText">loading...</div>
        </div>
        <div class="card">
          <div class="card-label">Online Now</div>
          <div class="card-value green" id="onlineDevices">â€”</div>
          <div class="card-sub" id="offlineText">â€” offline</div>
        </div>
        <div class="card">
          <div class="card-label">Pending Tasks</div>
          <div class="card-value yellow" id="pendingTasks">â€”</div>
          <div class="card-sub" id="failedText">â€” failed (24h)</div>
        </div>
        <div class="card">
          <div class="card-label">Needs Attention</div>
          <div class="card-value red" id="attentionCount">â€”</div>
          <div class="card-sub" id="attentionText">low battery / high CPU</div>
        </div>
      </div>

      <!-- Live device grid -->
      <div class="section-header">
        <div class="section-title">Live Devices</div>
        <div class="section-count" id="deviceCount">0</div>
        <div class="search-bar">
          <input class="search-input" id="deviceSearch" placeholder="search hostname..." oninput="filterDevices()">
          <button class="btn btn-primary btn-sm" onclick="openRunModal()">â–¶ Run Script</button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Device</th>
              <th>OS</th>
              <th>Status</th>
              <th>CPU</th>
              <th>RAM</th>
              <th>Disk</th>
              <th>Battery</th>
              <th>Last Seen</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="devicesTable">
            <tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text3);font-family:var(--mono);font-size:12px;">Loading devices...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â”€â”€ DEVICES detail page â”€â”€ -->
  <div class="page" id="page-devices">
    <div class="topbar">
      <div>
        <div class="topbar-title">Devices</div>
        <div class="topbar-sub">All managed endpoints</div>
      </div>
    </div>
    <div class="page-body">
      <p style="color:var(--text3);font-family:var(--mono);font-size:13px;">Click a device in the dashboard to view its detail panel.</p>
    </div>
  </div>

  <!-- â”€â”€ TASKS page â”€â”€ -->
  <div class="page" id="page-tasks">
    <div class="topbar">
      <div>
        <div class="topbar-title">Tasks</div>
        <div class="topbar-sub">Script runs, file pushes, scheduled jobs</div>
      </div>
      <div class="topbar-actions">
        <button class="btn btn-primary btn-sm" onclick="openRunModal()">+ New Task</button>
      </div>
    </div>
    <div class="page-body">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Task ID</th>
              <th>Device</th>
              <th>Type</th>
              <th>Status</th>
              <th>Language</th>
              <th>Created</th>
              <th>Completed</th>
              <th>Exit</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tasksTable">
            <tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text3);font-family:var(--mono);font-size:12px;">Loading tasks...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â”€â”€ SCRIPTS page â”€â”€ -->
  <div class="page" id="page-scripts">
    <div class="topbar">
      <div>
        <div class="topbar-title">Scripts</div>
        <div class="topbar-sub">Saved PowerShell, Bash, and Python scripts</div>
      </div>
      <div class="topbar-actions">
        <button class="btn btn-primary btn-sm" onclick="openNewScriptModal()">+ New Script</button>
      </div>
    </div>
    <div class="page-body" style="padding:0;">
      <div class="script-grid" style="padding:20px;">
        <div class="script-list" id="scriptList">
          <div style="padding:16px;font-family:var(--mono);font-size:12px;color:var(--text3);">Loading scripts...</div>
        </div>
        <div class="script-editor-panel">
          <div class="editor-toolbar">
            <span style="font-size:12px;font-family:var(--mono);color:var(--text3);" id="scriptEditorTitle">Select a script</span>
            <div style="margin-left:auto;display:flex;gap:8px;">
              <button class="btn btn-ghost btn-sm" id="btnRunScript" onclick="runSelectedScript()" style="display:none">â–¶ Run</button>
              <button class="btn btn-ghost btn-sm" id="btnSaveScript" onclick="saveScript()" style="display:none">ðŸ’¾ Save</button>
              <button class="btn btn-danger btn-sm" id="btnDeleteScript" onclick="deleteSelectedScript()" style="display:none">âœ• Delete</button>
            </div>
          </div>
          <textarea class="form-textarea" id="scriptContent"
            placeholder="Select or create a script..."
            style="flex:1;border:none;border-radius:0;background:var(--bg);font-size:12.5px;padding:16px;resize:none;height:100%"></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ FILES page â”€â”€ -->
  <div class="page" id="page-files">
    <div class="topbar">
      <div>
        <div class="topbar-title">File Transfer</div>
        <div class="topbar-sub">Upload files to push to devices</div>
      </div>
    </div>
    <div class="page-body">
      <div class="card" style="margin-bottom:20px;">
        <div class="card-label" style="margin-bottom:12px">Upload File</div>
        <div style="display:flex;gap:12px;align-items:center;">
          <input type="file" id="fileUploadInput" style="font-family:var(--mono);font-size:13px;color:var(--text2);">
          <button class="btn btn-primary btn-sm" onclick="uploadFile()">Upload</button>
        </div>
      </div>
      <div class="section-header"><div class="section-title">Uploaded Files</div></div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Filename</th><th>Size</th><th></th></tr></thead>
          <tbody id="filesTable"><tr><td colspan="3" style="text-align:center;padding:30px;color:var(--text3);font-family:var(--mono);font-size:12px">No files uploaded yet</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â”€â”€ POLICIES page â”€â”€ -->
  <div class="page" id="page-policies">
    <div class="topbar">
      <div>
        <div class="topbar-title">Check-in Policies</div>
        <div class="topbar-sub">Adaptive battery-aware check-in intervals</div>
      </div>
      <div class="topbar-actions">
        <button class="btn btn-primary btn-sm" onclick="openNewPolicyModal()">+ New Policy</button>
      </div>
    </div>
    <div class="page-body" id="policiesBody">
      <div style="font-family:var(--mono);font-size:12px;color:var(--text3)">Loading policies...</div>
    </div>
  </div>

  <!-- â”€â”€ NETBIRD page â”€â”€ -->
  <div class="page" id="page-netbird">
    <div class="topbar">
      <div>
        <div class="topbar-title">Netbird VPN</div>
        <div class="topbar-sub">Self-hosted peer-to-peer VPN</div>
      </div>
    </div>
    <div class="page-body">
      <div class="cards-row" style="grid-template-columns:repeat(2,1fr)">
        <div class="card">
          <div class="card-label">Management Server</div>
          <div id="nbMgmtStatus" style="font-size:14px;font-family:var(--mono);margin-top:8px;color:var(--text3)">Checking...</div>
        </div>
        <div class="card">
          <div class="card-label">Connected Peers</div>
          <div id="nbPeerCount" class="card-value accent">â€”</div>
        </div>
      </div>
      <div class="card" style="margin-bottom:20px;">
        <div class="card-label" style="margin-bottom:8px">Agent Setup Key</div>
        <div style="font-family:var(--mono);font-size:12px;color:var(--text2);line-height:1.8">
          Each device gets a unique one-time setup key when it registers.<br>
          Keys are automatically issued by the backend when a new agent enrolls.<br>
          You can view issued keys below.
        </div>
      </div>
      <div class="section-header"><div class="section-title">VPN Peers</div></div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Name</th><th>IP</th><th>OS</th><th>Connected</th><th>Last Seen</th></tr></thead>
          <tbody id="peersTable"><tr><td colspan="5" style="text-align:center;padding:30px;color:var(--text3);font-family:var(--mono);font-size:12px">Loading peers...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>
</div><!-- .main -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Run Script Modal -->
<div class="modal-overlay" id="modalRun">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Run Script / Task</div>
      <button class="modal-close" onclick="closeModal('modalRun')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <label class="form-label">Target Devices</label>
        <div id="deviceCheckboxes" style="display:flex;flex-wrap:wrap;gap:8px;max-height:120px;overflow-y:auto;padding:8px;background:var(--bg3);border-radius:6px;border:1px solid var(--border)">
          Loading devices...
        </div>
        <div style="display:flex;gap:8px;margin-top:6px;">
          <button class="btn btn-ghost btn-sm" onclick="selectAllDevices()">All Online</button>
          <button class="btn btn-ghost btn-sm" onclick="selectNoDevices()">None</button>
        </div>
      </div>
      <div class="form-row">
        <label class="form-label">Task Type</label>
        <select class="form-select" id="taskType" onchange="onTaskTypeChange()">
          <option value="script">Run Script</option>
          <option value="reboot">Reboot</option>
          <option value="shutdown">Shutdown</option>
          <option value="patch">Windows Update</option>
        </select>
      </div>
      <div id="scriptFields">
        <div class="form-row">
          <label class="form-label">Language</label>
          <select class="form-select" id="scriptLang">
            <option value="powershell">PowerShell</option>
            <option value="bash">Bash</option>
            <option value="python">Python</option>
          </select>
        </div>
        <div class="form-row">
          <label class="form-label">Script Content</label>
          <textarea class="form-textarea" id="runScriptContent" placeholder="# Write your script here&#10;Get-Date"></textarea>
        </div>
        <div class="form-row">
          <label class="form-label">Or choose saved script</label>
          <select class="form-select" id="savedScriptPicker" onchange="loadSavedScript()">
            <option value="">â€” select a saved script â€”</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <label class="form-label">Schedule (leave blank to run immediately)</label>
        <input type="datetime-local" class="form-input" id="scheduleAt">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalRun')">Cancel</button>
      <button class="btn btn-primary" onclick="dispatchTask()">â–¶ Dispatch</button>
    </div>
  </div>
</div>

<!-- Device Detail Modal -->
<div class="modal-overlay" id="modalDevice">
  <div class="modal" style="width:720px">
    <div class="modal-header">
      <div class="modal-title" id="modalDeviceTitle">Device Detail</div>
      <button class="modal-close" onclick="closeModal('modalDevice')">Ã—</button>
    </div>
    <div class="modal-body" id="modalDeviceBody">
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger btn-sm" onclick="removeCurrentDevice()">Remove Device</button>
      <button class="btn btn-ghost btn-sm" onclick="openGuacamole()">ðŸ–¥ Remote Desktop</button>
      <button class="btn btn-primary btn-sm" onclick="openRunForDevice()">â–¶ Run Script</button>
    </div>
  </div>
</div>

<!-- New Script Modal -->
<div class="modal-overlay" id="modalNewScript">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">New Script</div>
      <button class="modal-close" onclick="closeModal('modalNewScript')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <label class="form-label">Script Name</label>
        <input class="form-input" id="newScriptName" placeholder="My Script">
      </div>
      <div class="form-row">
        <label class="form-label">Language</label>
        <select class="form-select" id="newScriptLang">
          <option value="powershell">PowerShell</option>
          <option value="bash">Bash</option>
          <option value="python">Python</option>
        </select>
      </div>
      <div class="form-row">
        <label class="form-label">Description</label>
        <input class="form-input" id="newScriptDesc" placeholder="What does this script do?">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modalNewScript')">Cancel</button>
      <button class="btn btn-primary" onclick="createScript()">Create</button>
    </div>
  </div>
</div>

<!-- Task Output Modal -->
<div class="modal-overlay" id="modalTaskOutput">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Task Output</div>
      <button class="modal-close" onclick="closeModal('modalTaskOutput')">Ã—</button>
    </div>
    <div class="modal-body">
      <div id="taskOutputContent" class="terminal">Loading...</div>
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• JAVASCRIPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
const API = '/api';
let allDevices = [];
let allScripts = [];
let selectedDeviceId = null;
let selectedScriptId = null;
let ws = null;

// â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  event.currentTarget.classList.add('active');

  // Load page data
  if (name === 'tasks')    loadTasks();
  if (name === 'scripts')  loadScripts();
  if (name === 'policies') loadPolicies();
  if (name === 'netbird')  loadNetbird();
  if (name === 'files')    loadFiles();
}

// â”€â”€ API helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(path, opts = {}) {
  try {
    const r = await fetch(API + path, {
      headers: { 'Content-Type': 'application/json', ...opts.headers },
      ...opts
    });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
  } catch (e) {
    toast(e.message, 'error');
    return null;
  }
}

// â”€â”€ Toast notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, type = 'info') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<span>${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â„¹'}</span> ${msg}`;
  document.getElementById('toastContainer').appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

// â”€â”€ WebSocket live feed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectWS() {
  const wsUrl = `ws://${location.host}/ws/dashboard`;
  ws = new WebSocket(wsUrl);

  ws.onopen = () => {
    document.getElementById('wsStatus').textContent = 'Live feed connected';
    setInterval(() => ws.readyState === 1 && ws.send('ping'), 30000);
  };

  ws.onclose = () => {
    document.getElementById('wsStatus').textContent = 'Reconnecting...';
    setTimeout(connectWS, 3000);
  };

  ws.onmessage = (e) => {
    try {
      const msg = JSON.parse(e.data);
      handleWSMessage(msg);
    } catch {}
  };
}

function handleWSMessage(msg) {
  if (msg.event === 'device_stats') {
    // Update device row live
    const dev = allDevices.find(d => d.id === msg.device_id);
    if (dev) {
      Object.assign(dev, {
        cpu_percent: msg.cpu_percent,
        ram_percent: msg.ram_percent,
        disk_percent: msg.disk_percent,
        battery_percent: msg.battery_percent,
        battery_charging: msg.battery_charging,
        is_online: true,
        last_seen: msg.last_seen,
        status: 'online',
      });
      renderDevicesTable();
    }
  } else if (msg.event === 'device_status') {
    const dev = allDevices.find(d => d.id === msg.device_id);
    if (dev) {
      dev.status = msg.status;
      dev.is_online = msg.status === 'online';
      renderDevicesTable();
    }
  } else if (msg.event === 'task_complete') {
    toast(`Task completed on device (exit ${msg.exit_code})`, msg.exit_code === 0 ? 'success' : 'error');
  } else if (msg.event === 'device_registered') {
    toast(`New device enrolled: ${msg.hostname}`, 'success');
    loadDevices();
  }
}

// â”€â”€ Dashboard data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboard() {
  const summary = await api('/dashboard/summary');
  if (!summary) return;

  document.getElementById('totalDevices').textContent = summary.total_devices;
  document.getElementById('onlineDevices').textContent = summary.online_devices;
  document.getElementById('offlineText').textContent = `${summary.offline_devices} offline`;
  document.getElementById('pendingTasks').textContent = summary.pending_tasks;
  document.getElementById('failedText').textContent = `${summary.failed_tasks_24h} failed (24h)`;

  const attention = summary.low_battery_devices + summary.high_cpu_devices;
  document.getElementById('attentionCount').textContent = attention;
  document.getElementById('attentionText').textContent =
    `${summary.low_battery_devices} low battery Â· ${summary.high_cpu_devices} high CPU`;

  const osList = Object.entries(summary.devices_by_os || {})
    .map(([os, n]) => `${n} ${os}`).join(' Â· ');
  document.getElementById('byOsText').textContent = osList || 'no devices';

  // Update badges
  if (summary.offline_devices > 0) {
    document.getElementById('offlineBadge').style.display = '';
    document.getElementById('offlineBadge').textContent = summary.offline_devices;
  } else {
    document.getElementById('offlineBadge').style.display = 'none';
  }

  if (summary.pending_tasks > 0) {
    document.getElementById('pendingBadge').style.display = '';
    document.getElementById('pendingBadge').textContent = summary.pending_tasks;
  } else {
    document.getElementById('pendingBadge').style.display = 'none';
  }
}

async function loadDevices() {
  const data = await api('/agents/');
  if (!data) return;
  allDevices = data;
  renderDevicesTable();
  document.getElementById('deviceCount').textContent = allDevices.length;
}

function renderDevicesTable() {
  const search = document.getElementById('deviceSearch').value.toLowerCase();
  const filtered = allDevices.filter(d =>
    (d.display_name || d.hostname).toLowerCase().includes(search) ||
    (d.ip_address || '').includes(search)
  );

  const tbody = document.getElementById('devicesTable');
  if (!filtered.length) {
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text3);font-family:var(--mono);font-size:12px">No devices found</td></tr>`;
    return;
  }

  tbody.innerHTML = filtered.map(d => {
    const status = d.is_online ? 'online' : 'offline';
    const cpuColor = d.cpu_percent > 90 ? 'red' : d.cpu_percent > 70 ? 'yellow' : 'green';
    const ramColor = d.ram_percent > 90 ? 'red' : d.ram_percent > 75 ? 'yellow' : 'green';
    const diskColor = d.disk_percent > 90 ? 'red' : d.disk_percent > 75 ? 'yellow' : 'green';

    const battHtml = d.battery_percent !== null && d.battery_percent !== undefined
      ? buildBatteryHtml(d.battery_percent, d.battery_charging)
      : `<span style="color:var(--text3);font-family:var(--mono);font-size:11px">â€”</span>`;

    const lastSeen = d.last_seen
      ? timeSince(new Date(d.last_seen))
      : 'never';

    return `<tr onclick="openDevice('${d.id}')">
      <td>
        <div style="font-weight:600;font-size:13px">${d.display_name || d.hostname}</div>
        <div style="font-family:var(--mono);font-size:11px;color:var(--text3)">${d.ip_address || 'â€”'}</div>
      </td>
      <td><span class="os-badge os-${d.os}">${d.os}</span></td>
      <td><span class="status-dot ${status}">${status}</span></td>
      <td>${d.cpu_percent !== null ? gaugeHtml(d.cpu_percent, cpuColor) : 'â€”'}</td>
      <td>${d.ram_percent !== null ? gaugeHtml(d.ram_percent, ramColor) : 'â€”'}</td>
      <td>${d.disk_percent !== null ? gaugeHtml(d.disk_percent, diskColor) : 'â€”'}</td>
      <td>${battHtml}</td>
      <td style="font-family:var(--mono);font-size:11px;color:var(--text3)">${lastSeen}</td>
      <td>
        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openRunForDeviceId('${d.id}')">â–¶</button>
      </td>
    </tr>`;
  }).join('');
}

function gaugeHtml(pct, color) {
  const w = Math.min(100, Math.max(0, pct || 0));
  return `<div class="mini-gauge">
    <div class="gauge-bar"><div class="gauge-fill ${color}" style="width:${w}%"></div></div>
    <span class="gauge-val">${Math.round(w)}%</span>
  </div>`;
}

function buildBatteryHtml(pct, charging) {
  const w = Math.min(100, Math.max(0, pct));
  const color = pct <= 10 ? 'var(--red)' : pct <= 20 ? 'var(--orange)' : pct <= 50 ? 'var(--yellow)' : 'var(--green)';
  const fillW = Math.max(2, Math.round(w * 16 / 100));
  return `<div class="battery" style="color:${color}">
    <div class="battery-icon">
      <div class="battery-fill" style="width:${fillW}px;background:${color}"></div>
    </div>
    ${charging ? 'âš¡ ' : ''}${pct}%
  </div>`;
}

function timeSince(date) {
  const sec = Math.floor((new Date() - date) / 1000);
  if (sec < 60) return `${sec}s ago`;
  if (sec < 3600) return `${Math.floor(sec/60)}m ago`;
  if (sec < 86400) return `${Math.floor(sec/3600)}h ago`;
  return `${Math.floor(sec/86400)}d ago`;
}

function filterDevices() { renderDevicesTable(); }

// â”€â”€ Device detail modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openDevice(id) {
  selectedDeviceId = id;
  const d = await api(`/agents/${id}`);
  if (!d) return;

  document.getElementById('modalDeviceTitle').textContent = d.display_name || d.hostname;

  const battHtml = d.battery_percent !== null
    ? buildBatteryHtml(d.battery_percent, d.battery_charging)
    : 'â€”';

  document.getElementById('modalDeviceBody').innerHTML = `
    <div class="tabs">
      <div class="tab active" onclick="switchTab(event,'dtab-overview')">Overview</div>
      <div class="tab" onclick="switchTab(event,'dtab-history')">History</div>
    </div>
    <div id="dtab-overview">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px">
        <div class="card">
          <div class="card-label">Hostname</div>
          <div style="font-family:var(--mono);font-size:14px;margin-top:4px">${d.hostname}</div>
        </div>
        <div class="card">
          <div class="card-label">OS</div>
          <div style="margin-top:4px"><span class="os-badge os-${d.os}">${d.os}</span> ${d.os_version || ''}</div>
        </div>
        <div class="card">
          <div class="card-label">IP Address</div>
          <div style="font-family:var(--mono);font-size:14px;margin-top:4px">${d.ip_address || 'â€”'}</div>
        </div>
        <div class="card">
          <div class="card-label">VPN IP</div>
          <div style="font-family:var(--mono);font-size:14px;margin-top:4px">${d.netbird_ip || 'Not connected'}</div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px">
        <div class="card"><div class="card-label">CPU</div>${d.cpu_percent !== null ? gaugeHtml(d.cpu_percent, d.cpu_percent > 90 ? 'red' : 'green') : 'â€”'}</div>
        <div class="card"><div class="card-label">RAM</div>${d.ram_percent !== null ? gaugeHtml(d.ram_percent, d.ram_percent > 90 ? 'red' : 'green') : 'â€”'}</div>
        <div class="card"><div class="card-label">Battery</div><div style="margin-top:6px">${battHtml}</div></div>
      </div>
      <div class="card">
        <div class="card-label" style="margin-bottom:10px">Hardware</div>
        <div style="font-family:var(--mono);font-size:12px;color:var(--text2);line-height:2">
          CPU: ${d.cpu_model || 'â€”'}<br>
          RAM: ${d.ram_total_gb ? d.ram_total_gb + ' GB' : 'â€”'} &nbsp;Â·&nbsp;
          Disk: ${d.disk_total_gb ? d.disk_total_gb + ' GB' : 'â€”'}<br>
          Arch: ${d.arch || 'â€”'} &nbsp;Â·&nbsp;
          Agent: v${d.agent_version || '?'}<br>
          Last seen: ${d.last_seen ? new Date(d.last_seen).toLocaleString() : 'never'}
        </div>
      </div>
    </div>
    <div id="dtab-history" style="display:none">
      <div style="font-family:var(--mono);font-size:12px;color:var(--text3)">
        ${d.history && d.history.length
          ? d.history.slice(0,20).map(h =>
              `<div style="padding:6px 0;border-bottom:1px solid var(--border);display:flex;gap:24px">
                <span style="color:var(--text3)">${new Date(h.timestamp).toLocaleString()}</span>
                <span>CPU <b style="color:var(--text)">${h.cpu ?? 'â€”'}%</b></span>
                <span>RAM <b style="color:var(--text)">${h.ram ?? 'â€”'}%</b></span>
                <span>Battery <b style="color:var(--text)">${h.battery ?? 'â€”'}%${h.charging ? ' âš¡' : ''}</b></span>
              </div>`
            ).join('')
          : 'No history yet'}
      </div>
    </div>
  `;

  document.getElementById('modalDevice').classList.add('open');
}

function switchTab(e, id) {
  const parent = e.target.closest('.modal-body, .page-body');
  parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  e.target.classList.add('active');
  parent.querySelectorAll('[id^="dtab-"]').forEach(p => p.style.display = 'none');
  document.getElementById(id).style.display = '';
}

async function removeCurrentDevice() {
  if (!selectedDeviceId) return;
  if (!confirm('Remove this device?')) return;
  await api(`/agents/${selectedDeviceId}`, { method: 'DELETE' });
  closeModal('modalDevice');
  toast('Device removed', 'success');
  loadDevices();
  loadDashboard();
}

function openGuacamole() {
  window.open(`http://${location.hostname}:${location.port ? 8081 : 8081}/guacamole`, '_blank');
}

// â”€â”€ Tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTasks() {
  const data = await api('/tasks/?limit=200');
  if (!data) return;

  const statusColor = { pending: 'yellow', running: 'accent', success: 'green', failed: 'red', cancelled: 'text3' };
  const tbody = document.getElementById('tasksTable');

  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text3);font-family:var(--mono);font-size:12px">No tasks yet</td></tr>`;
    return;
  }

  tbody.innerHTML = data.map(t => `<tr>
    <td style="font-family:var(--mono);font-size:11px;color:var(--text3)">${t.id.slice(0,8)}</td>
    <td style="font-family:var(--mono);font-size:12px">${t.device_id.slice(0,8)}</td>
    <td style="font-family:var(--mono);font-size:12px">${t.task_type}</td>
    <td><span style="font-family:var(--mono);font-size:12px;color:var(--${statusColor[t.status] || 'text2'})">${t.status}</span></td>
    <td style="font-family:var(--mono);font-size:11px;color:var(--text3)">${t.script_language || 'â€”'}</td>
    <td style="font-family:var(--mono);font-size:11px;color:var(--text3)">${t.created_at ? timeSince(new Date(t.created_at)) : 'â€”'}</td>
    <td style="font-family:var(--mono);font-size:11px;color:var(--text3)">${t.completed_at ? timeSince(new Date(t.completed_at)) : 'â€”'}</td>
    <td style="font-family:var(--mono);font-size:12px;color:${t.exit_code === 0 ? 'var(--green)' : t.exit_code !== null ? 'var(--red)' : 'var(--text3)'}">${t.exit_code !== null ? t.exit_code : 'â€”'}</td>
    <td><button class="btn btn-ghost btn-sm" onclick="viewTaskOutput('${t.id}')">Output</button></td>
  </tr>`).join('');
}

async function viewTaskOutput(id) {
  const t = await api(`/tasks/${id}`);
  if (!t) return;
  const out = t.output || t.error || '(no output)';
  document.getElementById('taskOutputContent').innerHTML =
    `<div class="line info">Task: ${t.id}</div>` +
    `<div class="line info">Status: ${t.status} Â· Exit: ${t.exit_code ?? 'â€”'}</div>` +
    `<div class="line info">---</div>` +
    out.split('\n').map(l => `<div class="line${l.toLowerCase().includes('error') ? ' err' : ''}">${escHtml(l)}</div>`).join('');
  document.getElementById('modalTaskOutput').classList.add('open');
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€ Run script modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openRunModal() {
  populateDeviceCheckboxes();
  populateSavedScriptPicker();
  document.getElementById('modalRun').classList.add('open');
}

function openRunForDeviceId(id) {
  openRunModal();
  setTimeout(() => {
    document.querySelectorAll('#deviceCheckboxes input[type=checkbox]').forEach(cb => {
      cb.checked = cb.value === id;
    });
  }, 50);
}

function openRunForDevice() {
  if (selectedDeviceId) {
    closeModal('modalDevice');
    openRunForDeviceId(selectedDeviceId);
  }
}

function populateDeviceCheckboxes() {
  const online = allDevices.filter(d => d.is_online);
  document.getElementById('deviceCheckboxes').innerHTML = online.length
    ? online.map(d => `<label style="display:flex;align-items:center;gap:6px;font-size:12px;font-family:var(--mono);cursor:pointer;padding:4px 8px;background:var(--bg4);border-radius:4px">
        <input type="checkbox" value="${d.id}" checked style="accent-color:var(--accent)">
        ${d.display_name || d.hostname}
      </label>`).join('')
    : '<span style="color:var(--text3);font-family:var(--mono);font-size:12px">No online devices</span>';
}

function selectAllDevices() {
  document.querySelectorAll('#deviceCheckboxes input').forEach(i => i.checked = true);
}

function selectNoDevices() {
  document.querySelectorAll('#deviceCheckboxes input').forEach(i => i.checked = false);
}

function onTaskTypeChange() {
  const t = document.getElementById('taskType').value;
  document.getElementById('scriptFields').style.display = t === 'script' ? '' : 'none';
}

async function populateSavedScriptPicker() {
  if (!allScripts.length) {
    const data = await api('/scripts/');
    if (data) allScripts = data;
  }
  const sel = document.getElementById('savedScriptPicker');
  sel.innerHTML = '<option value="">â€” select a saved script â€”</option>' +
    allScripts.map(s => `<option value="${s.id}">${s.name} (${s.language})</option>`).join('');
}

async function loadSavedScript() {
  const id = document.getElementById('savedScriptPicker').value;
  if (!id) return;
  const s = await api(`/scripts/${id}`);
  if (!s) return;
  document.getElementById('runScriptContent').value = s.content;
  document.getElementById('scriptLang').value = s.language;
}

async function dispatchTask() {
  const deviceIds = [...document.querySelectorAll('#deviceCheckboxes input:checked')].map(i => i.value);
  if (!deviceIds.length) { toast('Select at least one device', 'error'); return; }

  const taskType = document.getElementById('taskType').value;
  const body = {
    device_ids: deviceIds,
    task_type: taskType,
  };

  if (taskType === 'script') {
    body.script_content = document.getElementById('runScriptContent').value;
    body.script_language = document.getElementById('scriptLang').value;
  }

  const schedVal = document.getElementById('scheduleAt').value;
  if (schedVal) body.scheduled_at = new Date(schedVal).toISOString();

  const result = await api('/tasks/', { method: 'POST', body: JSON.stringify(body) });
  if (result) {
    toast(`Dispatched ${result.count} task(s)`, 'success');
    closeModal('modalRun');
    loadTasks();
    loadDashboard();
  }
}

// â”€â”€ Scripts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadScripts() {
  const data = await api('/scripts/');
  if (!data) return;
  allScripts = data;

  const list = document.getElementById('scriptList');
  list.innerHTML = !data.length
    ? '<div style="padding:16px;font-family:var(--mono);font-size:12px;color:var(--text3)">No scripts yet</div>'
    : data.map(s => `
      <div class="script-item${selectedScriptId === s.id ? ' active' : ''}" onclick="selectScript('${s.id}')">
        <div class="script-name">${s.name}</div>
        <div class="script-lang">${s.language}</div>
      </div>`).join('');
}

async function selectScript(id) {
  selectedScriptId = id;
  const s = await api(`/scripts/${id}`);
  if (!s) return;
  document.getElementById('scriptEditorTitle').textContent = s.name;
  document.getElementById('scriptContent').value = s.content;
  document.getElementById('btnRunScript').style.display = '';
  document.getElementById('btnSaveScript').style.display = '';
  document.getElementById('btnDeleteScript').style.display = '';
  loadScripts(); // refresh active state
}

function openNewScriptModal() {
  document.getElementById('modalNewScript').classList.add('open');
}

async function createScript() {
  const name = document.getElementById('newScriptName').value.trim();
  if (!name) { toast('Name required', 'error'); return; }

  const result = await api('/scripts/', {
    method: 'POST',
    body: JSON.stringify({
      name,
      language: document.getElementById('newScriptLang').value,
      description: document.getElementById('newScriptDesc').value,
      content: `# ${name}\n`,
    })
  });

  if (result) {
    toast('Script created', 'success');
    closeModal('modalNewScript');
    loadScripts();
    selectedScriptId = result.id;
  }
}

async function saveScript() {
  if (!selectedScriptId) return;
  const s = allScripts.find(x => x.id === selectedScriptId);
  if (!s) return;
  await api(`/scripts/${selectedScriptId}`, {
    method: 'PUT',
    body: JSON.stringify({
      name: s.name,
      language: s.language,
      description: s.description,
      content: document.getElementById('scriptContent').value,
    })
  });
  toast('Script saved', 'success');
}

async function deleteSelectedScript() {
  if (!selectedScriptId) return;
  if (!confirm('Delete this script?')) return;
  await api(`/scripts/${selectedScriptId}`, { method: 'DELETE' });
  selectedScriptId = null;
  document.getElementById('scriptContent').value = '';
  document.getElementById('scriptEditorTitle').textContent = 'Select a script';
  ['btnRunScript','btnSaveScript','btnDeleteScript'].forEach(id => document.getElementById(id).style.display = 'none');
  toast('Script deleted', 'success');
  loadScripts();
}

function runSelectedScript() {
  if (!selectedScriptId) return;
  openRunModal();
  setTimeout(async () => {
    const s = await api(`/scripts/${selectedScriptId}`);
    if (s) {
      document.getElementById('runScriptContent').value = s.content;
      document.getElementById('scriptLang').value = s.language;
    }
  }, 50);
}

// â”€â”€ Policies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPolicies() {
  const data = await api('/policies/');
  if (!data) return;

  document.getElementById('policiesBody').innerHTML = data.map(p => `
    <div class="card" style="margin-bottom:16px">
      <div style="display:flex;align-items:center;margin-bottom:16px">
        <div>
          <div style="font-size:15px;font-weight:700">${p.name}</div>
          <div style="font-size:12px;font-family:var(--mono);color:var(--text3);margin-top:2px">${p.description || 'No description'}</div>
        </div>
        ${p.name !== 'default' ? `<button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="deletePolicy('${p.id}')">Delete</button>` : ''}
      </div>
      ${policySliders(p)}
    </div>`).join('');
}

function policySliders(p) {
  const rows = [
    { key: 'plugged_in_interval', label: 'âš¡ Plugged In / Charging', val: p.plugged_in_interval },
    { key: 'battery_80_100',      label: 'ðŸ”‹ Battery 80â€“100%',       val: p.battery_80_100 },
    { key: 'battery_50_79',       label: 'ðŸ”‹ Battery 50â€“79%',        val: p.battery_50_79 },
    { key: 'battery_20_49',       label: 'ðŸ”‹ Battery 20â€“49%',        val: p.battery_20_49 },
    { key: 'battery_10_19',       label: 'ðŸ”‹ Battery 10â€“19%',        val: p.battery_10_19 },
    { key: 'battery_0_9',         label: 'âš ï¸ Battery 0â€“9%',          val: p.battery_0_9 },
  ];

  return rows.map(r => `
    <div class="policy-row">
      <div class="policy-label">${r.label}</div>
      <input class="policy-slider" type="range" min="10" max="3600" step="10"
        value="${r.val}"
        oninput="updatePolicyVal('${p.id}','${r.key}',this.value)"
        onchange="savePolicyField('${p.id}','${r.key}',this.value,'${p.name}')">
      <div class="policy-val" id="pv-${p.id}-${r.key}">${fmtSec(r.val)}</div>
    </div>`).join('');
}

function updatePolicyVal(policyId, key, val) {
  document.getElementById(`pv-${policyId}-${key}`).textContent = fmtSec(val);
}

async function savePolicyField(policyId, key, val, name) {
  // Build updated policy object from current slider values
  const sliders = {};
  ['plugged_in_interval','battery_80_100','battery_50_79','battery_20_49','battery_10_19','battery_0_9'].forEach(k => {
    const el = document.querySelector(`input[onchange*="${policyId}"][onchange*="${k}"]`);
    if (el) sliders[k] = parseInt(el.value);
  });
  sliders[key] = parseInt(val);

  await api(`/policies/${policyId}`, {
    method: 'PUT',
    body: JSON.stringify({ name, ...sliders })
  });
  toast('Policy saved', 'success');
}

function fmtSec(s) {
  s = parseInt(s);
  if (s < 60) return `${s}s`;
  if (s < 3600) return `${Math.floor(s/60)}m`;
  return `${Math.floor(s/3600)}h`;
}

async function deletePolicy(id) {
  if (!confirm('Delete this policy?')) return;
  await api(`/policies/${id}`, { method: 'DELETE' });
  toast('Policy deleted', 'success');
  loadPolicies();
}

function openNewPolicyModal() {
  const name = prompt('Policy name:');
  if (!name) return;
  api('/policies/', { method: 'POST', body: JSON.stringify({ name }) }).then(() => {
    toast('Policy created', 'success');
    loadPolicies();
  });
}

// â”€â”€ Netbird â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadNetbird() {
  const status = await api('/netbird/status');
  if (status) {
    document.getElementById('nbMgmtStatus').innerHTML =
      status.online
        ? '<span style="color:var(--green)">â— Online</span>'
        : '<span style="color:var(--red)">â— Offline â€” check netbird-mgmt container</span>';
  }

  const peers = await api('/netbird/peers');
  const tbody = document.getElementById('peersTable');
  if (peers && Array.isArray(peers)) {
    document.getElementById('nbPeerCount').textContent = peers.length;
    tbody.innerHTML = peers.length
      ? peers.map(p => `<tr>
          <td style="font-family:var(--mono);font-size:13px">${p.name || 'â€”'}</td>
          <td style="font-family:var(--mono);font-size:12px;color:var(--accent)">${p.ip || 'â€”'}</td>
          <td><span class="os-badge os-${(p.os || 'unknown').toLowerCase()}">${p.os || 'â€”'}</span></td>
          <td><span class="status-dot ${p.connected ? 'online' : 'offline'}">${p.connected ? 'yes' : 'no'}</span></td>
          <td style="font-family:var(--mono);font-size:11px;color:var(--text3)">${p.lastSeen || 'â€”'}</td>
        </tr>`).join('')
      : `<tr><td colspan="5" style="text-align:center;padding:30px;color:var(--text3);font-family:var(--mono);font-size:12px">No peers connected yet â€” enroll a device to get started</td></tr>`;
  }
}

// â”€â”€ Files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadFiles() {
  const data = await api('/files/list');
  const tbody = document.getElementById('filesTable');
  if (!data || !data.length) {
    tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;padding:30px;color:var(--text3);font-family:var(--mono);font-size:12px">No files uploaded yet</td></tr>`;
    return;
  }
  tbody.innerHTML = data.map(f => `<tr>
    <td style="font-family:var(--mono);font-size:13px">${f.name}</td>
    <td style="font-family:var(--mono);font-size:12px;color:var(--text3)">${(f.size_bytes/1024).toFixed(1)} KB</td>
    <td><button class="btn btn-primary btn-sm" onclick="pushFile('${f.name}')">Push to Device</button></td>
  </tr>`).join('');
}

async function uploadFile() {
  const input = document.getElementById('fileUploadInput');
  if (!input.files.length) { toast('Select a file first', 'error'); return; }
  const form = new FormData();
  form.append('file', input.files[0]);
  try {
    const r = await fetch(API + '/files/upload', { method: 'POST', body: form });
    const data = await r.json();
    toast(`Uploaded ${data.file_name}`, 'success');
    loadFiles();
  } catch (e) {
    toast('Upload failed: ' + e.message, 'error');
  }
}

function pushFile(name) {
  const destPath = prompt(`Destination path on device:`, 'C:\\Users\\Public\\' + name);
  if (!destPath) return;
  openRunModal();
  setTimeout(() => {
    document.getElementById('taskType').value = 'file_push';
    onTaskTypeChange();
  }, 50);
}

// â”€â”€ Modal helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}

document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => {
    if (e.target === m) m.classList.remove('open');
  });
});

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshAll() {
  loadDashboard();
  loadDevices();
}

async function init() {
  await loadDevices();
  await loadDashboard();
  connectWS();
  setInterval(refreshAll, 30000); // Fallback poll every 30s
}

init();
</script>
</body>
</html>
