# ================================================================
# SOVEREIGN RMM — compose.yaml
# Paste this into Dockge. That's it. Everything builds from GitHub.
#
# GitHub repo: https://github.com/tesladog/sovereign-rmm
#
# BEFORE YOU START:
#   1. Set SERVER_IP in your .env to your Ubuntu machine's local IP
#   2. Change every password marked CHANGE_THIS in your .env
#   3. Hit Start in Dockge — all images build automatically
#
# PORTS (all on your SERVER_IP):
#   :8080  → Dashboard (open this in your browser)
#   :8000  → Agent API (agents talk to this)
#   :8090  → Guacamole remote desktop
#   :8081  → Netbird VPN management
#   :8082  → Netbird signal server
#   :33080 → Netbird relay (TURN)
# ================================================================

services:

  # ── POSTGRES ────────────────────────────────────────────────
  # Main database. Stores everything: devices, tasks, logs, policies.
  postgres:
    image: postgres:16-alpine
    container_name: rmm-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB:       ${POSTGRES_DB}
      POSTGRES_USER:     ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - rmm-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  # ── REDIS ────────────────────────────────────────────────────
  # Task queue + WebSocket pub/sub for instant push commands.
  redis:
    image: redis:7-alpine
    container_name: rmm-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - rmm-internal
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  # ── BACKEND ─────────────────────────────────────────────────
  # FastAPI server. Handles agent check-ins, WebSocket push,
  # task dispatch, and dashboard API.
  # Builds directly from GitHub — no local files needed.
  backend:
    build:
      context: https://github.com/tesladog/sovereign-rmm.git#main:backend
      dockerfile: Dockerfile
    image: sovereign-rmm-backend:latest
    container_name: rmm-backend
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      REDIS_URL:    redis://:${REDIS_PASSWORD}@redis:6379/0
      API_SECRET_KEY: ${API_SECRET_KEY}
      AGENT_TOKEN:    ${AGENT_TOKEN}
      SERVER_IP:      ${SERVER_IP}
      BACKEND_PORT:   ${BACKEND_PORT}
      ADMIN_USERNAME: ${ADMIN_USERNAME}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
    volumes:
      - rmm_files:/app/files
    ports:
      - "${BACKEND_PORT}:8000"
    networks:
      - rmm-internal
      - rmm-external
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ── FRONTEND ─────────────────────────────────────────────────
  # Nginx serving the dark-mode dashboard.
  # Dashboard HTML is baked into the image at build time.
  # Builds directly from GitHub — no local files needed.
  frontend:
    build:
      context: https://github.com/tesladog/sovereign-rmm.git#main:frontend
      dockerfile: Dockerfile
    image: sovereign-rmm-frontend:latest
    container_name: rmm-frontend
    restart: unless-stopped
    ports:
      - "${DASHBOARD_PORT}:80"
    networks:
      - rmm-internal
      - rmm-external
    depends_on:
      - backend

  # ── GUACAMOLE INIT ───────────────────────────────────────────
  # One-shot container that imports the Guacamole DB schema.
  # Runs once on first start, then exits cleanly.
  # Guacamole won't start until this completes.
  guacamole-init:
    image: guacamole/guacamole:latest
    container_name: rmm-guacamole-init
    restart: "no"
    command: >
      sh -c "
        echo 'Waiting for PostgreSQL...' &&
        until pg_isready -h postgres -U ${POSTGRES_USER}; do sleep 2; done &&
        echo 'Checking schema...' &&
        TABLE=$$(psql postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres/${POSTGRES_DB} -tAc
          \"SELECT COUNT(*) FROM information_schema.tables WHERE table_name='guacamole_connection'\") &&
        if [ \"$$TABLE\" -gt \"0\" ]; then
          echo 'Schema exists, skipping.';
        else
          echo 'Importing schema...' &&
          /opt/guacamole/bin/initdb.sh --postgresql |
          psql postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres/${POSTGRES_DB} &&
          echo 'Schema imported.';
        fi
      "
    environment:
      PGPASSWORD: ${POSTGRES_PASSWORD}
    networks:
      - rmm-internal
    depends_on:
      postgres:
        condition: service_healthy

  # ── GUACD ────────────────────────────────────────────────────
  # Guacamole protocol daemon. Speaks RDP, VNC, SSH natively.
  # Not exposed externally — only guacamole talks to it.
  guacd:
    image: guacamole/guacd:latest
    container_name: rmm-guacd
    restart: unless-stopped
    networks:
      - rmm-internal

  # ── GUACAMOLE ────────────────────────────────────────────────
  # Browser-based remote desktop. Access via dashboard.
  # Supports RDP (Windows), VNC, SSH — no client install needed.
  # Default login: guacadmin / guacadmin — CHANGE THIS IMMEDIATELY.
  guacamole:
    image: guacamole/guacamole:latest
    container_name: rmm-guacamole
    restart: unless-stopped
    environment:
      GUACD_HOSTNAME:        guacd
      GUACD_PORT:            4822
      POSTGRESQL_HOSTNAME:   postgres
      POSTGRESQL_PORT:       5432
      POSTGRESQL_DATABASE:   ${POSTGRES_DB}
      POSTGRESQL_USER:       ${POSTGRES_USER}
      POSTGRESQL_PASSWORD:   ${POSTGRES_PASSWORD}
    ports:
      - "${GUACAMOLE_PORT}:8080"
    networks:
      - rmm-internal
      - rmm-external
    depends_on:
      guacd:
        condition: service_started
      guacamole-init:
        condition: service_completed_successfully

  # ── NETBIRD MANAGEMENT ───────────────────────────────────────
  # Self-hosted VPN key server. Issues WireGuard keys to all devices.
  # No Netbird cloud. No external dependencies.
  # Access at http://SERVER_IP:8081 to manage keys.
  netbird-mgmt:
    image: netbirdio/management:latest
    container_name: rmm-netbird-mgmt
    restart: unless-stopped
    command:
      - "--port=80"
      - "--log-file=console"
      - "--disable-anonymous-metrics=true"
      - "--single-account-mode-domain=netbird.local"
      - "--dns-domain=netbird.local"
      - "--datadir=/var/lib/netbird"
      - "--idp-manager-extra-audiences=netbird"
    environment:
      NETBIRD_STORE_ENGINE: sqlite
    volumes:
      - netbird_mgmt_data:/var/lib/netbird
    ports:
      - "${NETBIRD_MGMT_PORT}:80"
    networks:
      - rmm-internal
      - rmm-external

  # ── NETBIRD SIGNAL ───────────────────────────────────────────
  # Peer discovery for WireGuard tunnels.
  netbird-signal:
    image: netbirdio/signal:latest
    container_name: rmm-netbird-signal
    restart: unless-stopped
    volumes:
      - netbird_signal_data:/var/lib/netbird
    ports:
      - "${NETBIRD_SIGNAL_PORT}:80"
    networks:
      - rmm-internal
      - rmm-external

  # ── NETBIRD RELAY ────────────────────────────────────────────
  # TURN relay for devices that can't connect directly (e.g. Android on mobile).
  netbird-relay:
    image: netbirdio/relay:latest
    container_name: rmm-netbird-relay
    restart: unless-stopped
    environment:
      NB_LOG_LEVEL:       info
      NB_LISTEN_ADDRESS:  ":33080"
      NB_EXPOSED_ADDRESS: "${SERVER_IP}:${NETBIRD_RELAY_PORT}"
      NB_AUTH_SECRET:     ${NETBIRD_RELAY_SECRET}
    ports:
      - "${NETBIRD_RELAY_PORT}:33080"
    networks:
      - rmm-internal
      - rmm-external

# ================================================================
# NETWORKS
# rmm-internal → container-to-container only
# rmm-external → exposed to your LAN
# ================================================================
networks:
  rmm-internal:
    driver: bridge
    internal: true
  rmm-external:
    driver: bridge

# ================================================================
# VOLUMES — All data lives here, survives restarts and updates
# ================================================================
volumes:
  postgres_data:
  redis_data:
  rmm_files:
  netbird_mgmt_data:
  netbird_signal_data:
